<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
    <meta name="theme-color" content="#F4F4F1" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="default" />
    <link rel="apple-touch-icon" href="%BASE_URL%icons/icon-192x192.png" />
    <link rel="manifest" href="%BASE_URL%manifest.webmanifest" />
    <link rel="icon" href="%BASE_URL%favicon.ico" />

    <!-- iOS splash images (generated by tools/generate-icons.js) - make these base-aware for project pages -->
    <link rel="apple-touch-startup-image" href="%BASE_URL%icons/apple-splash-640-1136.png" media="(device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2)" />
    <link rel="apple-touch-startup-image" href="%BASE_URL%icons/apple-splash-750-1334.png" media="(device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2)" />
    <link rel="apple-touch-startup-image" href="%BASE_URL%icons/apple-splash-1125-2436.png" media="(device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3)" />
    <link rel="apple-touch-startup-image" href="%BASE_URL%icons/apple-splash-1242-2688.png" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 3)" />
    <link rel="apple-touch-startup-image" href="%BASE_URL%icons/apple-splash-1536-2048.png" media="(device-width: 768px) and (device-height: 1024px) and (-webkit-device-pixel-ratio: 2)" />

    <title>Flow RSVP — Design System</title>
  <meta name="apple-mobile-web-app-title" content="Flow" />
    <script>
      // Emergency: run as early as possible to remove any stale ServiceWorker
      // before the plugin-inserted register script runs. This prevents old SW
      // from intercepting requests and serving mismatched bundles.
      (function(){
        try{
          if(typeof window === 'undefined' || !('serviceWorker' in navigator)) return;
          if(sessionStorage.getItem('__flow_sw_handled')) return;
          navigator.serviceWorker.getRegistrations().then(function(regs){
            try{ regs.forEach(r=>r.unregister().catch(()=>{})); }catch(e){}
            try{ if('caches' in window) caches.keys().then(keys=>keys.forEach(k=>caches.delete(k))); }catch(e){}
            sessionStorage.setItem('__flow_sw_handled','1');
          }).catch(()=>{});
          // Prevent subsequent registration attempts in this page load
          try{ navigator.serviceWorker.register = function(){ return Promise.resolve({unregister:()=>Promise.resolve(true)}); }; }catch(e){}
        }catch(e){}
      })();
    </script>
  </head>
  <body>
    <!-- Safety-Orange splash fallback for platforms that show initial paint -->
    <div id="splash-fallback" style="position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:#FF5C00;z-index:9999;">
      <img src="%BASE_URL%icons/flowy-icon.svg" alt="Flowy" style="width:120px;height:120px;border-radius:28px;" />
    </div>

    <div id="root"></div>
    <!-- Diagnostics overlay: shows logs and runtime errors when the app fails to mount -->
    <div id="flow-diagnostics" aria-live="polite" style="position:fixed;left:12px;right:12px;top:12px;z-index:10000;pointer-events:auto;max-height:40vh;overflow:auto;"> </div>
    <script>
      (function(){
        const di = document.getElementById('flow-diagnostics');
        function append(msg, kind='info'){
          try{
            const el = document.createElement('div');
            el.style.background = kind==='error' ? 'rgba(255,235,235,0.95)' : 'rgba(255,255,255,0.9)';
            el.style.border = '1px solid rgba(0,0,0,0.06)';
            el.style.padding = '8px 10px';
            el.style.marginBottom = '6px';
            el.style.fontSize = '13px';
            el.style.color = '#111';
            el.textContent = (new Date()).toISOString().split('T')[1].slice(0,12) + ' — ' + String(msg);
            di && di.appendChild(el);
          }catch(e){/* ignore */}
        }

        // Mirror console to on-screen diag
        ['log','warn','error','info'].forEach((k)=>{
          const orig = console[k];
          console[k] = function(){
            try{ append(Array.from(arguments).map(a=>typeof a==='string'?a:JSON.stringify(a)).join(' '), k==='error'?'error':'info'); }catch(e){}
            return orig.apply(console, arguments);
          };
        });

        window.addEventListener('error', function(ev){
          append('Uncaught error: ' + (ev && ev.error && ev.error.message ? ev.error.message : ev.message || ev.toString()), 'error');
        });
        window.addEventListener('unhandledrejection', function(ev){ append('Unhandled rejection: '+ (ev.reason && ev.reason.message ? ev.reason.message : String(ev.reason)), 'error'); });

        // Check module script network status and report
        function probeModuleScripts(){
          try{
            const scripts = Array.from(document.querySelectorAll('script[type="module"]'));
            if(!scripts.length){ append('No module scripts found in DOM before app load.', 'warn'); }
            scripts.forEach(s => {
              const src = s.src || '(inline)';
              append('Module script: ' + src);
              if(src && src.indexOf('http')===0){
                fetch(src, {method:'HEAD', cache:'no-store'}).then(r=>{
                  append('HEAD ' + src + ' -> ' + r.status + ' ' + r.statusText);
                }).catch(e=>{
                  append('Network fetch failed for ' + src + ' — ' + e, 'error');
                });
              }
              // attach error handler to script tag
              s.addEventListener('error', ()=> append('Script element error: ' + src, 'error'));
            });
          }catch(e){ append('probeModuleScripts failed: '+e, 'error'); }
        }

        // Report service worker state
        (async function(){
          try{
            if('serviceWorker' in navigator){
              const regs = await navigator.serviceWorker.getRegistrations();
              append('ServiceWorker registrations: ' + regs.length);
            } else append('ServiceWorker not supported.');
          }catch(e){ append('SW check failed: '+e, 'error'); }
        })();

        // Run a probe a bit after initial parsing to pick up transformed module src attributes
        setTimeout(probeModuleScripts, 200);

        // If the app hasn't called window.__FLOW_APP_READY within 5s, show a prominent banner
        setTimeout(()=>{
          if(!(window).__FLOW_APP_READY){
            append('App did not signal ready (window.__FLOW_APP_READY not set). Check console and network.', 'warn');
            const s = document.getElementById('splash-fallback');
            if(s){
              s.style.outline = '4px solid rgba(0,0,0,0.06)';
            }
            // Add an emergency 'Load app' button so users can force-fetch the bundle with a cache-busting query.
            try{
              const btn = document.createElement('button');
              btn.textContent = 'Force load app (cache-bust)';
              btn.style.cssText = 'position:fixed;left:12px;bottom:12px;z-index:10001;padding:10px 14px;background:#fff;border:2px solid rgba(0,0,0,0.06);border-radius:10px;font-weight:600';
              btn.onclick = async function(){
                append('User triggered force-load...');
                try{
                  const script = document.querySelector('script[type="module"][src]');
                  const src = script ? script.getAttribute('src') : null;
                  if(!src){ append('No module script src found', 'error'); return; }
                  const url = src + (src.indexOf('?')===-1?('?t='+Date.now()):('&t='+Date.now()));
                  append('Importing ' + url);
                  await import(url);
                  append('Dynamic import succeeded');
                }catch(e){ append('Dynamic import failed: '+String(e), 'error'); }
              };
              document.body.appendChild(btn);
            }catch(e){}
          }
        }, 5000);
      })();
    </script>
    <script>
      // Immediate fallback: mark app ready and remove splash so users aren't stuck on orange screen.
      try{
        window.__FLOW_APP_READY = true;
        const s = document.getElementById('splash-fallback');
        if(s && s.parentNode) s.parentNode.removeChild(s);
      }catch(e){}
    </script>
    <script>
      // Force-unregister service workers and clear caches for stuck/stale clients.
      // Only run once per browsing session to avoid reload loops.
      (async function(){
        try{
          if(!('serviceWorker' in navigator)) return;
          if(sessionStorage.getItem('__flow_sw_unregistered')) return;
          const regs = await navigator.serviceWorker.getRegistrations();
          if(regs && regs.length){
            await Promise.all(regs.map(r => r.unregister().catch(()=>{})));
            if('caches' in window){
              try{ const keys = await caches.keys(); await Promise.all(keys.map(k=>caches.delete(k))); }catch(e){}
            }
            sessionStorage.setItem('__flow_sw_unregistered','1');
            console.info('[FLOW] Force-unregistered service workers and cleared caches. Reloading once...');
            setTimeout(()=>location.reload(), 150);
          }
        }catch(e){console.warn('[FLOW] SW unregister failed', e)}
      })();
    </script>
    <script>
      // Preserve the splash until the app explicitly removes it.
      // Earlier behavior removed the splash on `load` which could leave a white screen
      // if the JS bundle failed to initialize — keep the splash so the app can
      // show an error UI instead. App will remove the splash on successful mount.
      window.__FLOW_PRESERVE_SPLASH = true;
      // progressive accessibility hint if the app hasn't mounted after 3s
      setTimeout(()=>{try{const s=document.getElementById('splash-fallback');if(s){s.setAttribute('aria-busy','true');const note=document.createElement('div');note.style.cssText='color:rgba(26,26,26,0.6);font-size:13px;margin-top:12px';note.textContent='Loading — if this persists, open DevTools → Console for details.';s.appendChild(note)}}catch(e){}},3000);
    </script>
    <script type="module" src="/src/main.tsx"></script>
  </body>
</html>
